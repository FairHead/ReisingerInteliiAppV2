<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="ReisingerIntelliApp_V4.Views.DeviceParametersPage"
    x:Name="DeviceParametersPageRoot"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:components="clr-namespace:ReisingerIntelliApp_V4.Components"
    xmlns:converters="clr-namespace:ReisingerIntelliApp_V4.Converters"
    xmlns:models="clr-namespace:ReisingerIntelliApp_V4.Models"
    xmlns:viewmodels="clr-namespace:ReisingerIntelliApp_V4.ViewModels"
    x:DataType="viewmodels:DeviceParametersPageViewModel"
    BackgroundColor="#1E1E1E"
    Shell.NavBarIsVisible="False">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            <converters:StringToBoolConverter x:Key="StringToBoolConverter" />
            <converters:IntToBoolConverter x:Key="IntToBoolConverter" />
            <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,Auto,Auto,*,Auto,Auto">
        <!--  Row 0: Header with Back Button and Title  -->
        <Border
            Grid.Row="0"
            Padding="20,15"
            StrokeThickness="0">
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Offset="0.0" Color="#2D2D2D" />
                    <GradientStop Offset="1.0" Color="Transparent" />
                </LinearGradientBrush>
            </Border.Background>

            <Grid ColumnDefinitions="Auto,*" RowDefinitions="*">
                <!--  Back Button  -->
                <Button
                    x:Name="BackButton"
                    Grid.Row="0"
                    Grid.Column="0"
                    Margin="0,0,0,7"
                    Padding="0,0,0,0"
                    BackgroundColor="Transparent"
                    BorderWidth="0"
                    Clicked="OnBackButtonClicked"
                    FontSize="30"
                    HeightRequest="40"
                    HorizontalOptions="Start"
                    Text="&#8249;"
                    TextColor="White"
                    VerticalOptions="Center"
                    WidthRequest="40" />

                <!--  Title  -->
                <Label
                    Grid.Row="0"
                    Grid.Column="1"
                    Margin="10,0,0,0"
                    FontFamily="SpaceMonoBold"
                    FontSize="20"
                    HorizontalOptions="Start"
                    Text="Device Parameters"
                    TextColor="White"
                    VerticalOptions="Center" />
            </Grid>
        </Border>

        <!--  Row 1: Device Info Card (Compact)  -->
        <Border
            Grid.Row="1"
            Margin="15,5,15,5"
            Padding="12"
            BackgroundColor="#2A2A2A"
            Stroke="#404040"
            StrokeThickness="1">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="10" />
            </Border.StrokeShape>
            
            <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto">
                <!--  Device Icon and Name  -->
                <Label
                    Grid.Row="0"
                    Grid.Column="0"
                    FontSize="20"
                    Text="ðŸ“±"
                    VerticalOptions="Center" />
                <StackLayout
                    Grid.Row="0"
                    Grid.Column="1"
                    Margin="10,0,0,0"
                    Spacing="2">
                    <Label
                        FontFamily="SpaceMonoBold"
                        FontSize="16"
                        Text="{Binding DeviceName}"
                        TextColor="White" />
                    <Label
                        FontFamily="SpaceMonoRegular"
                        FontSize="12"
                        Text="{Binding DeviceIp}"
                        TextColor="#4CAF50" />
                </StackLayout>
                
                <!--  Connection Type Badge  -->
                <Border
                    Grid.Row="0"
                    Grid.Column="2"
                    Padding="8,4"
                    BackgroundColor="#007AFF"
                    VerticalOptions="Center">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="8" />
                    </Border.StrokeShape>
                    <Label
                        FontFamily="SpaceMonoBold"
                        FontSize="10"
                        Text="{Binding ConnectionType}"
                        TextColor="White" />
                </Border>
                
                <!--  Last Refresh Info  -->
                <Label
                    Grid.Row="1"
                    Grid.Column="0"
                    Grid.ColumnSpan="3"
                    Margin="0,8,0,0"
                    FontSize="11"
                    HorizontalOptions="End"
                    IsVisible="{Binding LastRefreshTime, Converter={StaticResource StringToBoolConverter}}"
                    Text="{Binding LastRefreshTime, StringFormat='Letzte Aktualisierung: {0}'}"
                    TextColor="#808080" />
            </Grid>
        </Border>

        <!--  Row 2: Category Tabs  -->
        <ScrollView 
            Grid.Row="2" 
            Orientation="Horizontal" 
            HorizontalScrollBarVisibility="Never"
            Margin="15,5,15,5">
            <HorizontalStackLayout Spacing="8">
                <!--  All Categories Button  -->
                <Button
                    Padding="12,8"
                    BackgroundColor="{Binding SelectedCategory, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#2A2A2A|#007AFF', FallbackValue=#007AFF}"
                    Clicked="OnAllCategoriesClicked"
                    CornerRadius="8"
                    FontFamily="SpaceMonoBold"
                    FontSize="12"
                    Text="ðŸ“‹ Alle"
                    TextColor="White" />
                
                <!--  Zeiten  -->
                <Button
                    Padding="12,8"
                    BackgroundColor="#2A2A2A"
                    Clicked="OnCategoryClicked"
                    CommandParameter="Zeiten"
                    CornerRadius="8"
                    FontFamily="SpaceMonoBold"
                    FontSize="12"
                    Text="â±ï¸ Zeiten"
                    TextColor="White" />
                
                <!--  Weiten  -->
                <Button
                    Padding="12,8"
                    BackgroundColor="#2A2A2A"
                    Clicked="OnCategoryClicked"
                    CommandParameter="Weiten"
                    CornerRadius="8"
                    FontFamily="SpaceMonoBold"
                    FontSize="12"
                    Text="ðŸ“ Weiten"
                    TextColor="White" />
                
                <!--  Tempo  -->
                <Button
                    Padding="12,8"
                    BackgroundColor="#2A2A2A"
                    Clicked="OnCategoryClicked"
                    CommandParameter="Tempo"
                    CornerRadius="8"
                    FontFamily="SpaceMonoBold"
                    FontSize="12"
                    Text="ðŸš€ Tempo"
                    TextColor="White" />
                
                <!--  I/O  -->
                <Button
                    Padding="12,8"
                    BackgroundColor="#2A2A2A"
                    Clicked="OnCategoryClicked"
                    CommandParameter="IO"
                    CornerRadius="8"
                    FontFamily="SpaceMonoBold"
                    FontSize="12"
                    Text="ðŸ”Œ I/O"
                    TextColor="White" />
                
                <!--  Basis  -->
                <Button
                    Padding="12,8"
                    BackgroundColor="#2A2A2A"
                    Clicked="OnCategoryClicked"
                    CommandParameter="Basis"
                    CornerRadius="8"
                    FontFamily="SpaceMonoBold"
                    FontSize="12"
                    Text="âš™ï¸ Basis"
                    TextColor="White" />
            </HorizontalStackLayout>
        </ScrollView>

        <!--  Row 3: Status Messages and Count Info  -->
        <StackLayout Grid.Row="3" Padding="15,0" Spacing="8">
            <!--  Filter Info  -->
            <Label
                FontSize="11"
                HorizontalOptions="Center"
                TextColor="#007AFF">
                <Label.Text>
                    <MultiBinding StringFormat="Zeige {0} von {1} Parametern">
                        <Binding Path="FilteredCount" />
                        <Binding Path="VisibleParameterCount" />
                    </MultiBinding>
                </Label.Text>
            </Label>

            <!--  Validation/Modified Status Bar  -->
            <Grid
                ColumnDefinitions="*,*"
                ColumnSpacing="10"
                IsVisible="{Binding ParameterCount, Converter={StaticResource IntToBoolConverter}}">
                <Border
                    Grid.Column="0"
                    Padding="8,4"
                    BackgroundColor="#1A3A1A"
                    IsVisible="{Binding HasModifiedParameters}"
                    Stroke="#4CAF50"
                    StrokeThickness="1">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="6" />
                    </Border.StrokeShape>
                    <Label
                        FontSize="11"
                        HorizontalOptions="Center"
                        Text="{Binding ModifiedCount, StringFormat='âœï¸ {0} geÃ¤ndert'}"
                        TextColor="#4CAF50" />
                </Border>
                
                <Border
                    Grid.Column="1"
                    Padding="8,4"
                    BackgroundColor="#3A1A1A"
                    IsVisible="{Binding HasValidationErrors}"
                    Stroke="#FF3B30"
                    StrokeThickness="1">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="6" />
                    </Border.StrokeShape>
                    <Label
                        FontSize="11"
                        HorizontalOptions="Center"
                        Text="{Binding InvalidCount, StringFormat='âš ï¸ {0} ungÃ¼ltig'}"
                        TextColor="#FF3B30" />
                </Border>
            </Grid>

            <!--  Error Message  -->
            <Border
                Padding="10"
                BackgroundColor="#3A1A1A"
                IsVisible="{Binding HasError}"
                Stroke="#FF3B30"
                StrokeThickness="1">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8" />
                </Border.StrokeShape>
                <Label
                    FontSize="12"
                    HorizontalOptions="Center"
                    Text="{Binding StatusMessage}"
                    TextColor="#FF3B30" />
            </Border>

            <!--  Loading Message  -->
            <Border
                Padding="10"
                BackgroundColor="#1A3A5C"
                IsVisible="{Binding IsLoading}"
                Stroke="#007AFF"
                StrokeThickness="1">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8" />
                </Border.StrokeShape>
                <StackLayout HorizontalOptions="Center" Orientation="Horizontal" Spacing="10">
                    <ActivityIndicator
                        HeightRequest="20"
                        IsRunning="{Binding IsLoading}"
                        WidthRequest="20"
                        Color="#007AFF" />
                    <Label
                        FontSize="12"
                        Text="{Binding StatusMessage}"
                        TextColor="#007AFF"
                        VerticalOptions="Center" />
                </StackLayout>
            </Border>
        </StackLayout>

        <!--  Row 4: Parameters List - Grouped by Category  -->
        <CollectionView
            Grid.Row="4"
            Margin="15,8,15,0"
            IsGrouped="True"
            ItemsSource="{Binding ParameterGroups}">
            
            <!--  Group Header Template  -->
            <CollectionView.GroupHeaderTemplate>
                <DataTemplate x:DataType="models:ParameterGroupDisplayModel">
                    <Border
                        Margin="0,8,0,4"
                        Padding="12,8"
                        BackgroundColor="#252525"
                        Stroke="#404040"
                        StrokeThickness="1">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8" />
                        </Border.StrokeShape>
                        <Grid ColumnDefinitions="*,Auto">
                            <Label
                                Grid.Column="0"
                                FontFamily="SpaceMonoBold"
                                FontSize="14"
                                Text="{Binding CategoryName}"
                                TextColor="White"
                                VerticalOptions="Center" />
                            <Label
                                Grid.Column="1"
                                FontSize="12"
                                Text="{Binding ParameterCount, StringFormat='{0} Parameter'}"
                                TextColor="#808080"
                                VerticalOptions="Center" />
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.GroupHeaderTemplate>
            
            <!--  Item Template  -->
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:DeviceParameterDisplayModel">
                    <Grid Padding="0,2">
                        <Border
                            Padding="10,8"
                            BackgroundColor="{Binding HasValidationError, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#3A2020|#2D2D2D'}"
                            Stroke="{Binding HasValidationError, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF3B30|#404040'}"
                            StrokeThickness="1">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="8" />
                            </Border.StrokeShape>
                            
                            <Grid ColumnDefinitions="45,*,70,65" ColumnSpacing="8" RowDefinitions="Auto,Auto">
                                <!--  Parameter ID Badge  -->
                                <Border
                                    Grid.Row="0"
                                    Grid.Column="0"
                                    Padding="4,2"
                                    BackgroundColor="{Binding IsModified, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#3A5A3A|#3A3A3A'}"
                                    HorizontalOptions="Center"
                                    VerticalOptions="Center">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="4" />
                                    </Border.StrokeShape>
                                    <Label
                                        FontFamily="SpaceMonoBold"
                                        FontSize="11"
                                        HorizontalOptions="Center"
                                        Text="{Binding Id, StringFormat='#{0}'}"
                                        TextColor="#B0B0B0" />
                                </Border>
                                
                                <!--  Parameter Name + Unit + Range  -->
                                <StackLayout
                                    Grid.Row="0"
                                    Grid.Column="1"
                                    Spacing="1"
                                    VerticalOptions="Center">
                                    <Label
                                        FontFamily="SpaceMonoRegular"
                                        FontSize="13"
                                        LineBreakMode="TailTruncation"
                                        Text="{Binding Name}"
                                        TextColor="White" />
                                    <StackLayout Orientation="Horizontal" Spacing="8">
                                        <Label
                                            FontSize="10"
                                            IsVisible="{Binding UnitText, Converter={StaticResource StringToBoolConverter}}"
                                            Text="{Binding UnitText, StringFormat='[{0}]'}"
                                            TextColor="#606060" />
                                        <Label
                                            FontSize="10"
                                            Text="{Binding RangeText}"
                                            TextColor="#505050" />
                                    </StackLayout>
                                </StackLayout>
                                
                                <!--  Default Value  -->
                                <StackLayout
                                    Grid.Row="0"
                                    Grid.Column="2"
                                    HorizontalOptions="Center"
                                    Spacing="0"
                                    VerticalOptions="Center">
                                    <Label
                                        FontSize="9"
                                        HorizontalOptions="Center"
                                        Text="Standard"
                                        TextColor="#505050" />
                                    <Label
                                        FontFamily="SpaceMonoRegular"
                                        FontSize="11"
                                        HorizontalOptions="Center"
                                        Text="{Binding DefaultText}"
                                        TextColor="#707070" />
                                </StackLayout>
                                
                                <!--  Value Display - Tap to Edit  -->
                                <Border
                                    Grid.Row="0"
                                    Grid.Column="3"
                                    Padding="6,4"
                                    BackgroundColor="{Binding IsValueLoading, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#252525|#1A3A1A'}"
                                    Stroke="{Binding HasValidationError, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF3B30|#4CAF50'}"
                                    StrokeThickness="1"
                                    VerticalOptions="Center">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="6" />
                                    </Border.StrokeShape>
                                    <Label
                                        BackgroundColor="Transparent"
                                        FontFamily="SpaceMonoBold"
                                        FontSize="14"
                                        HorizontalOptions="Center"
                                        HorizontalTextAlignment="Center"
                                        Text="{Binding Value}"
                                        TextColor="{Binding IsValueLoading, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#505050|#4CAF50'}"
                                        VerticalOptions="Center">
                                        <Label.Triggers>
                                            <DataTrigger
                                                Binding="{Binding IsValueLoading}"
                                                TargetType="Label"
                                                Value="True">
                                                <Setter Property="Text" Value="Â·Â·Â·" />
                                            </DataTrigger>
                                            <DataTrigger
                                                Binding="{Binding HasValidationError}"
                                                TargetType="Label"
                                                Value="True">
                                                <Setter Property="TextColor" Value="#FF3B30" />
                                            </DataTrigger>
                                        </Label.Triggers>
                                        <Label.GestureRecognizers>
                                            <TapGestureRecognizer
                                                CommandParameter="{Binding .}"
                                                Tapped="OnParameterValueTapped" />
                                        </Label.GestureRecognizers>
                                    </Label>
                                </Border>
                                
                                <!--  Validation Error Row  -->
                                <Label
                                    Grid.Row="1"
                                    Grid.Column="0"
                                    Grid.ColumnSpan="4"
                                    FontSize="9"
                                    HorizontalOptions="End"
                                    IsVisible="{Binding HasValidationError}"
                                    Text="{Binding ValidationError}"
                                    TextColor="#FF3B30" />
                            </Grid>
                        </Border>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
            
            <!--  Empty View  -->
            <CollectionView.EmptyView>
                <Border
                    Margin="0,20"
                    Padding="20"
                    BackgroundColor="#2D2D2D"
                    Stroke="#404040"
                    StrokeThickness="1">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10" />
                    </Border.StrokeShape>
                    <StackLayout HorizontalOptions="Center" Spacing="10">
                        <Label
                            FontSize="32"
                            HorizontalOptions="Center"
                            Text="ðŸ“‹" />
                        <Label
                            FontSize="14"
                            HorizontalOptions="Center"
                            Text="Keine Parameter in dieser Kategorie"
                            TextColor="#B0B0B0" />
                        <Label
                            FontSize="12"
                            HorizontalOptions="Center"
                            Text="WÃ¤hlen Sie eine andere Kategorie"
                            TextColor="#666666" />
                    </StackLayout>
                </Border>
            </CollectionView.EmptyView>
        </CollectionView>

        <!--  Row 5: Fixed Action Button Area  -->
        <Border
            Grid.Row="5"
            Padding="15,10,15,10"
            BackgroundColor="#1E1E1E"
            StrokeThickness="0">
            <Button
                Padding="15,12"
                BackgroundColor="{Binding HasValidationErrors, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#666666|#4CAF50'}"
                BorderColor="{Binding HasValidationErrors, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#505050|#388E3C'}"
                BorderWidth="2"
                Command="{Binding SaveParametersCommand}"
                CornerRadius="10"
                FontFamily="SpaceMonoBold"
                FontSize="16"
                HorizontalOptions="Fill"
                IsEnabled="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                Text="ðŸ’¾ Parameter Speichern"
                TextColor="White" />
        </Border>

        <!--  Row 6: Footer Component  -->
        <components:AppFooter
            x:Name="Footer"
            Grid.Row="6"
            CenterIcon="refresh.svg" />
    </Grid>

</ContentPage>