<?xml version="1.0" encoding="utf-8" ?>
<!--  ✅ CRITICAL: ContentView ist InputTransparent="True" -->
<!--  Nur explizit markierte Kinder (Card, Buttons) empfangen Input -->
<!--  Dadurch gehen Pan/Pinch-Gesten zum PanPinchContainer durch -->
<ContentView
    x:Class="ReisingerIntelliApp_V4.Components.PlacedDeviceControl"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:ReisingerIntelliApp_V4.Converters"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:vm="clr-namespace:ReisingerIntelliApp_V4.ViewModels"
    x:Name="placedDeviceControl"
    x:DataType="vm:PlacedDeviceControlViewModel"
    BackgroundColor="Transparent"
    Loaded="OnControlLoaded">

    <ContentView.Resources>
        <ResourceDictionary>
            <converters:BoolToOpenCloseConverter x:Key="BoolToOpenCloseConverter" />
            <converters:DoorStateToColorConverter x:Key="DoorStateToColorConverter" />
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
        </ResourceDictionary>
    </ContentView.Resources>

    <!--  Main Container  -->
    <AbsoluteLayout
        x:Name="MainContainer"
        BackgroundColor="Transparent"
        HeightRequest="600"
        HorizontalOptions="Center"
        VerticalOptions="Center"
        WidthRequest="600">

        <!--  ═══════════════════════  SCALE BUTTONS (top, only in move-mode)  ═══════════════════════  -->
        <Grid
            x:Name="ScaleBtnGrid"
            AbsoluteLayout.LayoutBounds="0.5,0.18,220,0"
            AbsoluteLayout.LayoutFlags="PositionProportional"
            BackgroundColor="Transparent"
            ColumnDefinitions="Auto,*,Auto"
            HeightRequest="44"
            IsVisible="{Binding IsInMoveMode}"
            VerticalOptions="Start">

            <ImageButton
                x:Name="ScalePlusDeviceButton"
                Grid.Column="0"
                Padding="8"
                BackgroundColor="{StaticResource PlacedDeviceActionBg}"
                BorderColor="{StaticResource PlacedDeviceMoveButton}"
                BorderWidth="2"
                Command="{Binding ScalePlusCommand}"
                CornerRadius="22"
                HeightRequest="44"
                Loaded="OnScaleButtonLoaded"
                Source="plus.svg"
                WidthRequest="44">
                <ImageButton.Behaviors>
                    <toolkit:IconTintColorBehavior TintColor="{StaticResource PlacedDeviceMoveButton}" />
                    <toolkit:EventToCommandBehavior EventName="Pressed" Command="{Binding InteractivePressedCommand}" />
                    <toolkit:EventToCommandBehavior EventName="Released" Command="{Binding InteractiveReleasedCommand}" />
                </ImageButton.Behaviors>
            </ImageButton>

            <BoxView Grid.Column="1" BackgroundColor="Transparent" />

            <ImageButton
                x:Name="ScaleMinusDeviceButton"
                Grid.Column="2"
                Padding="8"
                BackgroundColor="{StaticResource PlacedDeviceActionBg}"
                BorderColor="{StaticResource PlacedDeviceMoveButton}"
                BorderWidth="2"
                Command="{Binding ScaleMinusCommand}"
                CornerRadius="22"
                HeightRequest="44"
                Loaded="OnScaleButtonLoaded"
                Source="minus.svg"
                WidthRequest="44">
                <ImageButton.Behaviors>
                    <toolkit:IconTintColorBehavior TintColor="{StaticResource PlacedDeviceMoveButton}" />
                    <toolkit:EventToCommandBehavior EventName="Pressed" Command="{Binding InteractivePressedCommand}" />
                    <toolkit:EventToCommandBehavior EventName="Released" Command="{Binding InteractiveReleasedCommand}" />
                </ImageButton.Behaviors>
            </ImageButton>
        </Grid>

        <!--  ═══════════════════════  MOVE ARROWS (only in move-mode)  ═══════════════════════  -->
        <AbsoluteLayout
            x:Name="ArrowButtonsContainer"
            AbsoluteLayout.LayoutBounds="0.5,0.5,480,480"
            AbsoluteLayout.LayoutFlags="PositionProportional"
            IsVisible="{Binding IsInMoveMode}"
            ZIndex="99">

            <!--  Up  -->
            <ImageButton
                x:Name="NeonArrowUp"
                Padding="10"
                AbsoluteLayout.LayoutBounds="0.5,0.04,52,52"
                AbsoluteLayout.LayoutFlags="PositionProportional"
                BackgroundColor="{StaticResource PlacedDeviceActionBg}"
                BorderColor="{StaticResource PlacedDeviceMoveButton}"
                BorderWidth="2"
                Command="{Binding MoveUpCommand}"
                CommandParameter="Up"
                CornerRadius="26"
                HeightRequest="60"
                Loaded="OnArrowLoaded"
                Source="arrow_up.svg"
                WidthRequest="60">
                <ImageButton.Behaviors>
                    <toolkit:IconTintColorBehavior TintColor="{StaticResource PlacedDeviceMoveButton}" />
                    <toolkit:EventToCommandBehavior EventName="Pressed" Command="{Binding InteractivePressedCommand}" />
                    <toolkit:EventToCommandBehavior EventName="Released" Command="{Binding InteractiveReleasedCommand}" />
                </ImageButton.Behaviors>
            </ImageButton>

            <!--  Down  -->
            <ImageButton
                x:Name="NeonArrowDown"
                Padding="10"
                AbsoluteLayout.LayoutBounds="0.5,0.96,52,52"
                AbsoluteLayout.LayoutFlags="PositionProportional"
                BackgroundColor="{StaticResource PlacedDeviceActionBg}"
                BorderColor="{StaticResource PlacedDeviceMoveButton}"
                BorderWidth="2"
                Command="{Binding MoveDownCommand}"
                CommandParameter="Down"
                CornerRadius="26"
                HeightRequest="60"
                Loaded="OnArrowLoaded"
                Source="arrow_down.svg"
                WidthRequest="60">
                <ImageButton.Behaviors>
                    <toolkit:IconTintColorBehavior TintColor="{StaticResource PlacedDeviceMoveButton}" />
                    <toolkit:EventToCommandBehavior EventName="Pressed" Command="{Binding InteractivePressedCommand}" />
                    <toolkit:EventToCommandBehavior EventName="Released" Command="{Binding InteractiveReleasedCommand}" />
                </ImageButton.Behaviors>
            </ImageButton>

            <!--  Left  -->
            <ImageButton
                x:Name="NeonArrowLeft"
                Padding="10"
                AbsoluteLayout.LayoutBounds="0.04,0.5,52,52"
                AbsoluteLayout.LayoutFlags="PositionProportional"
                BackgroundColor="{StaticResource PlacedDeviceActionBg}"
                BorderColor="{StaticResource PlacedDeviceMoveButton}"
                BorderWidth="2"
                Command="{Binding MoveLeftCommand}"
                CommandParameter="Left"
                CornerRadius="26"
                HeightRequest="60"
                Loaded="OnArrowLoaded"
                Source="arrow_left.svg"
                WidthRequest="60">
                <ImageButton.Behaviors>
                    <toolkit:IconTintColorBehavior TintColor="{StaticResource PlacedDeviceMoveButton}" />
                    <toolkit:EventToCommandBehavior EventName="Pressed" Command="{Binding InteractivePressedCommand}" />
                    <toolkit:EventToCommandBehavior EventName="Released" Command="{Binding InteractiveReleasedCommand}" />
                </ImageButton.Behaviors>
            </ImageButton>

            <!--  Right  -->
            <ImageButton
                x:Name="NeonArrowRight"
                Padding="10"
                AbsoluteLayout.LayoutBounds="0.96,0.5,52,52"
                AbsoluteLayout.LayoutFlags="PositionProportional"
                BackgroundColor="{StaticResource PlacedDeviceActionBg}"
                BorderColor="{StaticResource PlacedDeviceMoveButton}"
                BorderWidth="2"
                Command="{Binding MoveRightCommand}"
                CommandParameter="Right"
                CornerRadius="26"
                HeightRequest="60"
                Loaded="OnArrowLoaded"
                Source="arrow_right.svg"
                WidthRequest="60">
                <ImageButton.Behaviors>
                    <toolkit:IconTintColorBehavior TintColor="{StaticResource PlacedDeviceMoveButton}" />
                    <toolkit:EventToCommandBehavior EventName="Pressed" Command="{Binding InteractivePressedCommand}" />
                    <toolkit:EventToCommandBehavior EventName="Released" Command="{Binding InteractiveReleasedCommand}" />
                </ImageButton.Behaviors>
            </ImageButton>
        </AbsoluteLayout>

        <!--  ═══════════════════════  DEVICE CARD  ═══════════════════════  -->
        <Border
            AbsoluteLayout.LayoutBounds="175,175,250,AutoSize"
            AbsoluteLayout.LayoutFlags="None"
            BackgroundColor="{StaticResource PlacedDeviceCardBackground}"
            HorizontalOptions="Center"
            Stroke="{StaticResource PlacedDeviceCardBorder}"
            StrokeThickness="1.5"
            VerticalOptions="Center"
            ZIndex="0">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="20" />
            </Border.StrokeShape>
            <Border.Shadow>
                <Shadow
                    Brush="{StaticResource PlacedDeviceCardShadow}"
                    Opacity="0.6"
                    Radius="28"
                    Offset="0,4" />
            </Border.Shadow>

            <Grid InputTransparent="False" RowDefinitions="Auto,Auto,Auto">

                <!--  ──── Row 0: Device Name + IP + Online Indicator ────  -->
                <VerticalStackLayout
                    Grid.Row="0"
                    Padding="16,14,16,0"
                    Spacing="2">
                    <Label
                        FontAttributes="Bold"
                        FontFamily="SpaceMonoBold"
                        FontSize="16"
                        HorizontalOptions="Center"
                        LineBreakMode="MiddleTruncation"
                        MaxLines="1"
                        Text="{Binding Name}"
                        TextColor="{StaticResource PlacedDeviceText}" />
                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                        <Ellipse
                            Fill="{Binding IsOnline, Converter={StaticResource BoolToColorConverter}}"
                            HeightRequest="8"
                            VerticalOptions="Center"
                            WidthRequest="8" />
                        <Label
                            FontFamily="SpaceMonoRegular"
                            FontSize="10"
                            LineBreakMode="TailTruncation"
                            MaxLines="1"
                            Opacity="0.7"
                            Text="{Binding NetworkInfo}"
                            TextColor="{StaticResource PlacedDeviceTextSecondary}" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>

                <!--  ──── Row 1: Door Button (hero element) ────  -->
                <Border
                    Grid.Row="1"
                    Margin="0,12,0,0"
                    BackgroundColor="Transparent"
                    HeightRequest="115"
                    HorizontalOptions="Center"
                    Stroke="Transparent"
                    StrokeThickness="1"
                    WidthRequest="115">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="55" />
                    </Border.StrokeShape>

                    <!--  Outer glow ring  -->
                    <Grid>
                        <Ellipse
                            Fill="Transparent"
                            HeightRequest="115"
                            HorizontalOptions="Center"
                            Stroke="{StaticResource PlacedDeviceMoveButton}"
                            StrokeThickness="2.5"
                            VerticalOptions="Center"
                            WidthRequest="115"
                            Opacity="0.5" />
                        <ImageButton
                            Padding="8"
                            BackgroundColor="{Binding PlacedDevice.IsDoorOpen, Converter={StaticResource DoorStateToColorConverter}}"
                            BorderColor="{StaticResource PlacedDeviceMoveButton}"
                            BorderWidth="3"
                            Command="{Binding ControlViewModel.ToggleDoorCommand}"
                            CornerRadius="38"
                            HeightRequest="100"
                            HorizontalOptions="Center"
                            IsEnabled="{Binding ControlViewModel.DoorActionInProgress, Converter={StaticResource InvertedBoolConverter}}"
                            VerticalOptions="Center"
                            WidthRequest="100">
                            <ImageButton.Behaviors>
                                <toolkit:EventToCommandBehavior EventName="Pressed" Command="{Binding InteractivePressedCommand}" />
                                <toolkit:EventToCommandBehavior EventName="Released" Command="{Binding InteractiveReleasedCommand}" />
                            </ImageButton.Behaviors>
                            <ImageButton.Source>
                                <FontImageSource
                                    FontFamily="SpaceMonoBold"
                                    Glyph="{Binding ControlViewModel.IsDoorOpen, Converter={StaticResource BoolToOpenCloseConverter}}"
                                    Size="13"
                                    Color="White" />
                            </ImageButton.Source>
                        </ImageButton>
                    </Grid>
                </Border>

                <!--  ──── Row 2: Action buttons row (move · settings · parameters · delete) ────  -->
                <Grid
                    Grid.Row="2"
                    Margin="12,10,12,12"
                    ColumnDefinitions="Auto,*,Auto,Auto,*,Auto"
                    ColumnSpacing="8"
                    HorizontalOptions="Fill">

                    <!--  Move Button  -->
                    <ImageButton
                        x:Name="DevicePlacementModeBtn"
                        Grid.Column="0"
                        Padding="6"
                        BackgroundColor="{StaticResource PlacedDeviceActionBg}"
                        BorderColor="{StaticResource PlacedDeviceMoveButton}"
                        BorderWidth="1.5"
                        Command="{Binding ToggleMoveModeCommand}"
                        CornerRadius="18"
                        HeightRequest="36"
                        InputTransparent="False"
                        IsEnabled="True"
                        Loaded="OnArrowLoaded"
                        Source="move.svg"
                        WidthRequest="36">
                        <ImageButton.Behaviors>
                            <toolkit:IconTintColorBehavior TintColor="{StaticResource PlacedDeviceMoveButton}" />
                            <toolkit:EventToCommandBehavior EventName="Pressed" Command="{Binding InteractivePressedCommand}" />
                            <toolkit:EventToCommandBehavior EventName="Released" Command="{Binding InteractiveReleasedCommand}" />
                        </ImageButton.Behaviors>
                        <VisualStateManager.VisualStateGroups>
                            <VisualStateGroup Name="PlacementModeStates">
                                <VisualState Name="Active">
                                    <VisualState.Setters>
                                        <Setter Property="BackgroundColor" Value="{StaticResource PlacedDeviceMoveButton}" />
                                        <Setter Property="BorderColor" Value="{StaticResource PlacedDeviceActiveBorder}" />
                                        <Setter Property="BorderWidth" Value="2.5" />
                                    </VisualState.Setters>
                                </VisualState>
                                <VisualState Name="Inactive">
                                    <VisualState.Setters>
                                        <Setter Property="BackgroundColor" Value="{StaticResource PlacedDeviceActionBg}" />
                                        <Setter Property="BorderColor" Value="{StaticResource PlacedDeviceMoveButton}" />
                                        <Setter Property="BorderWidth" Value="1.5" />
                                    </VisualState.Setters>
                                </VisualState>
                            </VisualStateGroup>
                        </VisualStateManager.VisualStateGroups>
                    </ImageButton>

                    <!--  Settings Button (name, credentials)  -->
                    <ImageButton
                        Grid.Column="2"
                        Padding="6"
                        BackgroundColor="{StaticResource PlacedDeviceActionBg}"
                        BorderColor="{StaticResource PlacedDeviceMoveButton}"
                        BorderWidth="1.5"
                        Command="{Binding OpenDeviceSettingsCommand}"
                        CornerRadius="18"
                        HeightRequest="36"
                        Source="settings.svg"
                        WidthRequest="36">
                        <ImageButton.Behaviors>
                            <toolkit:IconTintColorBehavior TintColor="{StaticResource PlacedDeviceMoveButton}" />
                        </ImageButton.Behaviors>
                    </ImageButton>

                    <!--  Parameters Button (device API parameters)  -->
                    <ImageButton
                        Grid.Column="3"
                        Padding="6"
                        BackgroundColor="{StaticResource PlacedDeviceActionBg}"
                        BorderColor="{StaticResource PlacedDeviceMoveButton}"
                        BorderWidth="1.5"
                        Command="{Binding OpenDeviceParametersCommand}"
                        CornerRadius="18"
                        HeightRequest="36"
                        Source="configuredevicebutton.svg"
                        WidthRequest="36">
                        <ImageButton.Behaviors>
                            <toolkit:IconTintColorBehavior TintColor="{StaticResource PlacedDeviceMoveButton}" />
                        </ImageButton.Behaviors>
                    </ImageButton>

                    <!--  Delete Button  -->
                    <ImageButton
                        Grid.Column="5"
                        Padding="6"
                        BackgroundColor="{StaticResource PlacedDeviceDeleteButton}"
                        BorderColor="Transparent"
                        BorderWidth="0"
                        Command="{Binding DeleteDeviceCommand}"
                        CornerRadius="18"
                        HeightRequest="36"
                        Source="bin.svg"
                        WidthRequest="36">
                        <ImageButton.Behaviors>
                            <toolkit:IconTintColorBehavior TintColor="{StaticResource PlacedDeviceMoveButton}" />
                        </ImageButton.Behaviors>
                    </ImageButton>
                </Grid>
            </Grid>
        </Border>
    </AbsoluteLayout>
</ContentView>
