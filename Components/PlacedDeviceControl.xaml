<?xml version="1.0" encoding="utf-8" ?>
<ContentView
    x:Class="ReisingerIntelliApp_V4.Components.PlacedDeviceControl"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:ReisingerIntelliApp_V4.Converters"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:vm="clr-namespace:ReisingerIntelliApp_V4.ViewModels"
    x:Name="placedDeviceControl"
    x:DataType="vm:PlacedDeviceControlViewModel"
    BackgroundColor="Transparent"
    Loaded="OnControlLoaded">

    <ContentView.Resources>
        <ResourceDictionary>
            <converters:BoolToOpenCloseConverter x:Key="BoolToOpenCloseConverter" />
            <converters:DoorStateToColorConverter x:Key="DoorStateToColorConverter" />
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        </ResourceDictionary>
    </ContentView.Resources>

    <!--  Main Container - AbsoluteLayout for overlay positioning (T032 fix)  -->
    <AbsoluteLayout
        x:Name="MainContainer"
        BackgroundColor="Transparent"
        HeightRequest="600"
        HorizontalOptions="Center"
        VerticalOptions="Center"
        WidthRequest="600">

        <Grid
            x:Name="ScaleBtnGrid"
            AbsoluteLayout.LayoutBounds="0.5,0.200,250,0"
            AbsoluteLayout.LayoutFlags="PositionProportional"
            BackgroundColor="Transparent"
            ColumnDefinitions="Auto,*,Auto"
            HeightRequest="50"
            IsVisible="{Binding IsInMoveMode}"
            VerticalOptions="Start">

            <!--  Scale Plus Button  -->
            <ImageButton
                x:Name="ScalePlusDeviceButton"
                Grid.Column="0"
                Padding="10"
                BackgroundColor="Grey"
                BorderColor="{StaticResource PlacedDeviceMoveButton}"
                BorderWidth="4"
                Command="{Binding ScalePlusCommand}"
                CornerRadius="25"
                HeightRequest="50"
                Loaded="OnScaleButtonLoaded"
                Source="plus.svg"
                WidthRequest="50">
                <ImageButton.Behaviors>
                    <toolkit:EventToCommandBehavior 
                        EventName="Pressed" 
                        Command="{Binding InteractivePressedCommand}" />
                    <toolkit:EventToCommandBehavior 
                        EventName="Released" 
                        Command="{Binding InteractiveReleasedCommand}" />
                </ImageButton.Behaviors>
            </ImageButton>

            <!--  Spacer (mittlere Spalte)  -->
            <BoxView Grid.Column="1" BackgroundColor="Transparent" />

            <!--  Scale Minus Button  -->
            <ImageButton
                x:Name="ScaleMinusDeviceButton"
                Grid.Column="2"
                Padding="10"
                BackgroundColor="Grey"
                BorderColor="{StaticResource PlacedDeviceMoveButton}"
                BorderWidth="4"
                Command="{Binding ScaleMinusCommand}"
                CornerRadius="25"
                HeightRequest="50"
                Loaded="OnScaleButtonLoaded"
                Source="minus.svg"
                WidthRequest="50">
                <ImageButton.Behaviors>
                    <toolkit:EventToCommandBehavior 
                        EventName="Pressed" 
                        Command="{Binding InteractivePressedCommand}" />
                    <toolkit:EventToCommandBehavior 
                        EventName="Released" 
                        Command="{Binding InteractiveReleasedCommand}" />
                </ImageButton.Behaviors>
            </ImageButton>
        </Grid>



        <!--  Move Buttons Container (T032: Overlay with HaloSpacing, always above Card)  -->
        <AbsoluteLayout
            x:Name="ArrowButtonsContainer"
            AbsoluteLayout.LayoutBounds="0.5,0.5,480,480"
            AbsoluteLayout.LayoutFlags="PositionProportional"
            InputTransparent="False"
            IsVisible="{Binding IsInMoveMode}"
            ZIndex="99">

            <!--  Up Arrow  -->
            <ImageButton
                x:Name="NeonArrowUp"
                Padding="0"
                AbsoluteLayout.LayoutBounds="0.5,0.06,75,65"
                AbsoluteLayout.LayoutFlags="PositionProportional"
                BackgroundColor="Transparent"
                Command="{Binding MoveUpCommand}"
                CommandParameter="Up"
                Loaded="OnArrowLoaded"
                Source="placementbuttonup.svg"
                Style="{StaticResource NeonArrowStyle}">
                <ImageButton.Behaviors>
                    <toolkit:EventToCommandBehavior 
                        EventName="Pressed" 
                        Command="{Binding InteractivePressedCommand}" />
                    <toolkit:EventToCommandBehavior 
                        EventName="Released" 
                        Command="{Binding InteractiveReleasedCommand}" />
                </ImageButton.Behaviors>
            </ImageButton>

            <!--  Down Arrow  -->
            <ImageButton
                x:Name="NeonArrowDown"
                Padding="0"
                AbsoluteLayout.LayoutBounds="0.5,0.94,44,24"
                AbsoluteLayout.LayoutFlags="PositionProportional"
                BackgroundColor="Transparent"
                Command="{Binding MoveDownCommand}"
                CommandParameter="Down"
                Loaded="OnArrowLoaded"
                Source="placementbuttondown.svg"
                Style="{StaticResource NeonArrowStyle}">
                <ImageButton.Behaviors>
                    <toolkit:EventToCommandBehavior 
                        EventName="Pressed" 
                        Command="{Binding InteractivePressedCommand}" />
                    <toolkit:EventToCommandBehavior 
                        EventName="Released" 
                        Command="{Binding InteractiveReleasedCommand}" />
                </ImageButton.Behaviors>
            </ImageButton>

            <!--  Left Arrow  -->
            <ImageButton
                x:Name="NeonArrowLeft"
                Padding="0"
                AbsoluteLayout.LayoutBounds="0.06,0.5,24,44"
                AbsoluteLayout.LayoutFlags="PositionProportional"
                BackgroundColor="Transparent"
                Command="{Binding MoveLeftCommand}"
                CommandParameter="Left"
                Loaded="OnArrowLoaded"
                Source="placementbuttonleft.svg"
                Style="{StaticResource NeonArrowStyle}">
                <ImageButton.Behaviors>
                    <toolkit:EventToCommandBehavior 
                        EventName="Pressed" 
                        Command="{Binding InteractivePressedCommand}" />
                    <toolkit:EventToCommandBehavior 
                        EventName="Released" 
                        Command="{Binding InteractiveReleasedCommand}" />
                </ImageButton.Behaviors>
            </ImageButton>

            <!--  Right Arrow  -->
            <ImageButton
                x:Name="NeonArrowRight"
                Padding="0"
                AbsoluteLayout.LayoutBounds="0.94,0.5,24,44"
                AbsoluteLayout.LayoutFlags="PositionProportional"
                BackgroundColor="Transparent"
                Command="{Binding MoveRightCommand}"
                CommandParameter="Right"
                Loaded="OnArrowLoaded"
                Source="placementbuttonright.svg"
                Style="{StaticResource NeonArrowStyle}">
                <ImageButton.Behaviors>
                    <toolkit:EventToCommandBehavior 
                        EventName="Pressed" 
                        Command="{Binding InteractivePressedCommand}" />
                    <toolkit:EventToCommandBehavior 
                        EventName="Released" 
                        Command="{Binding InteractiveReleasedCommand}" />
                </ImageButton.Behaviors>
            </ImageButton>
        </AbsoluteLayout>




        <!--  Feature Card (Main Device Info) - Auto height by content  -->
        <Border
            AbsoluteLayout.LayoutBounds="175,175,250,AutoSize"
            AbsoluteLayout.LayoutFlags="None"
            Background="{StaticResource PlacedDeviceAddButton}"
            HorizontalOptions="Center"
            Stroke="{StaticResource PlacedDeviceMoveButton}"
            StrokeThickness="3"
            VerticalOptions="Center"
            ZIndex="0">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="16" />
            </Border.StrokeShape>
            <Border.Shadow>
                <Shadow
                    Brush="#00BFFF"
                    Opacity="0.85"
                    Radius="22"
                    Offset="0,0" />
            </Border.Shadow>
            <Grid>
                <Grid InputTransparent="False" RowDefinitions="Auto,Auto,Auto">

                    <!--  Device Info Container (Top)  -->
                    <StackLayout
                        Grid.Row="0"
                        Margin="10,9,10,0"
                        HorizontalOptions="Center"
                        Spacing="4"
                        VerticalOptions="Start">

                        <!--  Device Name  -->
                        <Label
                            FontFamily="SpaceMonoBold"
                            FontSize="25"
                            HorizontalOptions="Center"
                            LineBreakMode="MiddleTruncation"
                            MaxLines="1"
                            Text="{Binding Name}"
                            TextColor="{StaticResource PlacedDeviceText}"
                            TextDecorations="Underline" />

                        <!--  Network info: show SSID for WiFi devices, otherwise IP address  -->
                        <Label
                            FontFamily="SpaceMonoRegular"
                            FontSize="10"
                            HorizontalOptions="Center"
                            LineBreakMode="TailTruncation"
                            MaxLines="1"
                            Text="{Binding NetworkInfo}"
                            TextColor="{StaticResource PlacedDeviceTextSecondary}"
                            TextDecorations="Underline" />
                    </StackLayout>

                    <!--  Spacer removed so label can sit directly under buttons  -->

                    <!--  Button Row at Bottom  -->
                    <Grid
                        Grid.Row="1"
                        Margin="0,10,0,0"
                        ColumnDefinitions="Auto,Auto,Auto"
                        HorizontalOptions="Center"
                        RowDefinitions="Auto,Auto,Auto"
                        VerticalOptions="Center">



                        <!--  Delete Device Button (Left)  -->
                        <ImageButton
                            Grid.Row="2"
                            Grid.RowSpan="1"
                            Grid.Column="2"
                            Margin="5,50,0,0"
                            Aspect="Center"
                            BackgroundColor="{StaticResource PlacedDeviceDeleteButton}"
                            BorderColor="#FFD60A"
                            BorderWidth="2"
                            Command="{Binding DeleteDeviceCommand}"
                            CornerRadius="22"
                            HorizontalOptions="Center"
                            MinimumHeightRequest="45"
                            MinimumWidthRequest="45"
                            Source="bin.svg"
                            VerticalOptions="Center" />

                        <!--  Large Open/Close Button (Center)  -->
                        <Border
                            Grid.Row="1"
                            Grid.RowSpan="2"
                            Grid.Column="1"
                            Margin="1"
                            BackgroundColor="Transparent"
                            Stroke="{StaticResource Primary}"
                            StrokeThickness="6">



                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="55" />
                            </Border.StrokeShape>

                            <ImageButton
                                Padding="10"
                                BackgroundColor="{Binding PlacedDevice.IsDoorOpen, Converter={StaticResource DoorStateToColorConverter}}"
                                BorderColor="{StaticResource PlacedDeviceMoveButton}"
                                BorderWidth="5"
                                Command="{Binding ControlViewModel.ToggleDoorCommand}"
                                CornerRadius="50"
                                HeightRequest="110"
                                HorizontalOptions="Center"
                                IsEnabled="{Binding ControlViewModel.DoorActionInProgress, Converter={StaticResource InvertedBoolConverter}}"
                                VerticalOptions="Center"
                                WidthRequest="110">
                                <ImageButton.Behaviors>
                                    <toolkit:EventToCommandBehavior 
                                        EventName="Pressed" 
                                        Command="{Binding InteractivePressedCommand}" />
                                    <toolkit:EventToCommandBehavior 
                                        EventName="Released" 
                                        Command="{Binding InteractiveReleasedCommand}" />
                                </ImageButton.Behaviors>
                                <ImageButton.Source>
                                    <FontImageSource
                                        FontFamily="SpaceMonoBold"
                                        Glyph="{Binding ControlViewModel.IsDoorOpen, Converter={StaticResource BoolToOpenCloseConverter}}"
                                        Size="14"
                                        Color="Black" />
                                </ImageButton.Source>
                            </ImageButton>
                        </Border>


                        <!--  Move Device Button (Right)  -->
                        <ImageButton
                            x:Name="DevicePlacementModeBtn"
                            Grid.Row="3"
                            Grid.RowSpan="1"
                            Grid.Column="0"
                            Margin="0,50,5,0"
                            Aspect="Center"
                            Command="{Binding ToggleMoveModeCommand}"
                            CornerRadius="22"
                            HorizontalOptions="Center"
                            InputTransparent="False"
                            IsEnabled="True"
                            Loaded="OnArrowLoaded"
                            MinimumHeightRequest="45"
                            MinimumWidthRequest="45"
                            Source="move.svg"
                            VerticalOptions="Center">
                            <ImageButton.Behaviors>
                                <toolkit:EventToCommandBehavior 
                                    EventName="Pressed" 
                                    Command="{Binding InteractivePressedCommand}" />
                                <toolkit:EventToCommandBehavior 
                                    EventName="Released" 
                                    Command="{Binding InteractiveReleasedCommand}" />
                            </ImageButton.Behaviors>
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup Name="PlacementModeStates">
                                    <VisualState Name="Active">
                                        <VisualState.Setters>
                                            <Setter Property="BackgroundColor" Value="{StaticResource PlacedDeviceConfigButton}" />
                                            <Setter Property="BorderColor" Value="{StaticResource PlacedDeviceActiveBorder}" />
                                            <Setter Property="BorderWidth" Value="4" />
                                        </VisualState.Setters>
                                    </VisualState>
                                    <VisualState Name="Inactive">
                                        <VisualState.Setters>
                                            <Setter Property="BackgroundColor" Value="{StaticResource PlacedDeviceMoveButton}" />
                                            <Setter Property="BorderColor" Value="{StaticResource PlacedDeviceConfigButton}" />
                                            <Setter Property="BorderWidth" Value="2" />
                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                        </ImageButton>
                    </Grid>

                    <!--  Dropdown split-button: primary action + selector  -->
                    <Grid
                        Grid.Row="2"
                        Margin="10,10,10,12"
                        ColumnDefinitions="*,Auto"
                        HorizontalOptions="Center">
                        <Button
                            Grid.Column="0"
                            Padding="12,8"
                            BackgroundColor="{StaticResource PlacedDeviceConfigButton}"
                            BorderColor="{StaticResource PlacedDeviceMoveButton}"
                            BorderWidth="2"
                            Command="{Binding ExecuteSelectedModeCommand}"
                            CornerRadius="10"
                            FontFamily="SpaceMonoBold"
                            FontSize="12"
                            Text="{Binding SelectedModeText}" />
                        <Button
                            Grid.Column="1"
                            Margin="8,0,0,0"
                            Padding="10,8"
                            BackgroundColor="{StaticResource PlacedDeviceConfigButton}"
                            BorderColor="{StaticResource PlacedDeviceMoveButton}"
                            BorderWidth="2"
                            Command="{Binding OpenModeSelectorCommand}"
                            CornerRadius="10"
                            FontFamily="SpaceMonoBold"
                            FontSize="12"
                            Text="â–¼" />
                    </Grid>
                </Grid>
            </Grid>

        </Border>
    </AbsoluteLayout>
</ContentView>
